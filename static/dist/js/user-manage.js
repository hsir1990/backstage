var userManageMod={identityData:null,pagerObj:null,userListParams:{userName:"",createTimeStart:"",createTimeEnd:"",identityId:"",pageSize:20,currentPage:""},userListData:null,popObj:null,importPop:null,popInnerHtml:"",init:function(){var t=this;t.getIdentityData(),t.getUserList(),t.bindEvents(),$("#J-form").datepicker({language:"zh-CN",autoclose:!0,format:"yyyy-mm-dd",inputs:$("#J-form").find("input.J-date-picker")})},getIdentityData:function(){var t=this;$.ajax({url:"/identity/get",method:"get",type:"json",timeout:1e4,success:function(e){if(e.code=1){var n={};$.each(e.data,function(t,e){n[e.id]=e.identity_name}),t.identityData=n,t.popInnerHtml=H.template($("#J-pop-tpl").html(),{identityData:t.identityData}),$("#J-form").find("select[name=identityId]").append(H.template($("#J-identity-option-tpl").html(),{identityData:t.identityData})),H.Monitor.trigger("getIdentityData")}else H.alert("请求用户身份字典失败")},error:function(){H.alert("请求用户身份字典失败")}})},getUserList:function(){var t=this;$.ajax({url:"/user/list",method:"get",type:"json",cache:!1,timeout:1e4,data:t.userListParams,beforeSend:function(){H.Loading.show()},success:function(e){(e.code=1)?(t.userListData=e.data,t.renderUserList(e.data)):H.alert("请求用户列表失败")},error:function(){H.alert("请求用户列表失败")},complete:function(){H.Loading.hide()}})},renderUserList:function(t){var e=this;H.Monitor.listen("getIdentityData",function(){var n=H.template($("#J-table-tpl").html(),t);$("#J-table-wrap").html(n),t.totalCount>0?(null==e.pagerObj&&(e.pagerObj=new H.Pager({tplB:$("#J-pager-tpl").html(),wrapB:$("#J-pager-wrap"),goToPageFunc:function(t){e.userListParams.currentPage=t,e.getUserList()}})),e.pagerObj.render({pg:t.currentPage,total:t.totalCount,ps:t.pageSize})):$("#J-pager-wrap").html("")})},saveUserMsg:function(t){var e=this;$.ajax({url:"/user/save",method:"post",type:"json",timeout:1e4,data:t,beforeSend:function(){H.Loading.show()},success:function(t){1==t.code&&e.popObj.remove(),H.alert(t.msg,2e3,function(){e.getUserList()})},error:function(){H.alert("用户信息保存接口调用失败")},complete:function(){H.Loading.hide()}})},delUser:function(t){var e=this;$.ajax({url:"/user/del",method:"post",type:"json",timeout:1e4,data:{ids:t},beforeSend:function(){H.Loading.show()},success:function(t){1==t.code?H.alert(t.msg,2e3,function(){e.getUserList()}):H.alert(t.msg)},error:function(){H.alert("用户删除接口调用失败")},complete:function(){H.Loading.hide()}})},showImportPop:function(){var t=this;t.importPop=H.dialog({title:"批量导入用户",content:$("#J-import-pop-tpl").html(),quickClose:!0,padding:10,backdropOpacity:.3}).show()},importUsers:function(){var t=this,e=new FormData(document.getElementById("J-import-form"));$.ajax({url:"/user/import",type:"POST",data:e,cache:!1,contentType:!1,processData:!1,beforeSend:function(){H.Loading.show()},success:function(e){if(1==e.code){var n=e.msg;0!=e.data.fails.length&&$.each(e.data.fails,function(t,e){n+="<br/>"+e.userName+e.msg}),H.alert(n,function(){t.importPop.remove(),t.getUserList()})}else H.alert(e.msg)},error:function(){},complete:function(){H.Loading.hide()}})},bindEvents:function(){var t=this;$("#J-date-wrap").datepicker({language:"zh-CN",autoclose:!0,format:"yyyy-mm-dd",inputs:$("#J-date-wrap").find("input.J-date-picker")}),$("#J-import-btn").on("click",function(){t.showImportPop()}),$(document).on("click","#J-add-btn, #J-table-wrap a.J-edit-btn",function(e){e.preventDefault();var n=$(this);t.popObj=H.dialog({title:"add"==n.data("type")?"新增用户":"修改用户信息",content:t.popInnerHtml,quickClose:!0,padding:10,backdropOpacity:.3,onshow:function(){if("edit"==n.data("type")){var t=userManageMod.userListData.list[1*n.data("index")],e=$("#J-pop-form");e.find("input[name=id]").val(t.id),e.find("input[name=userName]").val(t.user_name),e.find("input[name=userRealName]").val(t.user_real_name),e.find("input[name=userNickName]").val(t.user_nick_name),e.find("input[name=userJobNumber]").val(t.user_job_number),e.find("select[name=identityId]").val(t.user_identity_id)}},onclose:function(){}}).show()}).on("submit","#J-form",function(e){e.preventDefault();var n=$(this).serializeArray();$.each(n,function(t,e){userManageMod.userListParams[e.name]=e.value}),userManageMod.userListParams.currentPage=1,t.getUserList()}).on("submit","#J-pop-form",function(e){e.preventDefault(),t.saveUserMsg($(this).serialize())}).on("click","#J-pop-cancel-btn",function(){t.popObj.remove()}).on("click","#J-table-wrap a.J-del-btn",function(e){e.preventDefault();var n=$(this);H.confirm({content:"确定要删除此用户？",quickClose:!0,width:300,okValue:"确定",backdropOpacity:.3,ok:function(){t.delUser(n.data("id"))},cancelValue:"取消",cancel:function(){}}).show()}).on("change","#J-import-form input[type=file]",function(t){$(this).next().text(t.currentTarget.files[0].name)}).on("click","#J-import-cancel-btn",function(){t.importPop.remove()}).on("click","#J-import-do-btn",function(){t.importUsers()})}};$(function(){userManageMod.init()});