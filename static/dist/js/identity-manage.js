var identityManageMod={popObj:null,menuListData:null,identityData:null,pageData:null,competenceData:null,init:function(){var e=this;e.getIdentityList(),e.getMenuList(),e.getPageList(),e.bindEvents(),e.createMenu()},getIdentityList:function(){var e=this;$.ajax({url:"/identity/get",type:"get",dataType:"json",timeout:1e4,beforeSend:function(){H.Loading.show()},success:function(t){if(t.code=1){var n={};$.each(t.data,function(e,t){n[t.id]=t}),e.identityData=n,$("#J-role-select").append(H.template($("#J-identity-option-tpl").html(),{identityData:e.identityData})),H.Monitor.trigger("getIdentityList")}else H.alert("请求用户身份字典失败")},error:function(){H.alert("请求用户身份字典失败")},complete:function(){H.Loading.hide()}})},getMenuList:function(){var e=this;$.ajax({type:"get",dataType:"json",url:"menu/list",beforeSend:function(){H.Loading.show()},success:function(t){1==t.code?(e.menuListData=e.processData(t.data),H.Monitor.trigger("getMenuList")):H.alert(t.msg)},error:function(){H.alert("获取用户菜单列表失败")},complete:function(){H.Loading.hide()}})},processData:function(e){var t=[],n=function(e,t,i){$.each(t,function(a,o){"undefined"==typeof o.submenu&&(o.submenu=[]),o.parent_id==e&&(i.push(o),n(o.id,t,o.submenu))})};return n(0,e,t),t},getPageList:function(e){var t=this;$.ajax({url:"/competence/pageList",type:"get",dataType:"json",timeout:1e4,beforeSend:function(){H.Loading.show()},success:function(e){if(e.code=1){if(e.data.length>0){var n={};$.each(e.data,function(e,t){n[t.id]=t}),t.pageData=n}else t.pageData=null;t.getCompetenceList()}else H.alert("模块数据获取失败")},error:function(){H.alert("模块数据获取失败")},complete:function(){H.Loading.hide()}})},getCompetenceList:function(){var e=this;$.ajax({type:"get",dataType:"json",url:"/competence/competenceList",beforeSend:function(){H.Loading.show()},success:function(t){if(1==t.code){var n=t.data;_.each(e.pageData,function(e,t){e.competenceList=_.filter(n,function(e){return e.page_id==t})}),H.Monitor.trigger("getCompetenceList")}else H.alert("权限数据获取失败")},error:function(){H.alert("权限数据获取失败")},complete:function(){H.Loading.hide()}})},createMenu:function(){H.Monitor.listen("getIdentityList, getMenuList, getCompetenceList",function(){var e=identityManageMod.identityData[$("#J-role-select").val()],t=H.template($("#J-menu-tpl").html(),{identityName:e.identity_name,items:identityManageMod.menuListData,competence:e.identity_competence.split(","),pageData:identityManageMod.pageData,limit:e.identity_operating_limits.split(",")});$("#J-menu-wrap").html(t)})},saveIdentityCompetence:function(){var e=this,t=[],n="",i=[],a="",o=$("#J-role-select").val(),c=$("#J-menu-wrap").find("input[name=identityName]").val();return""==c?void H.alert("角色名不能为空!"):($("#J-menu-wrap").find("input[name=identityCompetence]:checked").each(function(){t.push($(this).val())}),n=t.join(","),$("#J-menu-wrap").find("input[name=competenceList]:checked").each(function(){i.push($(this).val())}),a=i.join(","),void $.ajax({url:"/identity/update",type:"post",dataType:"json",timeout:1e4,data:{identityId:o,identityName:c,identityCompetence:n,identityOperatingLimits:a},beforeSend:function(){H.Loading.show()},success:function(t){1==t.code?(e.identityData[o].identity_competence=n,e.identityData[o].identity_operating_limits=a,$("#J-role-select").find("option:selected").text(c),H.alert("保存成功!")):H.alert(t.msg)},error:function(){H.alert("保存角色权限接口调用失败")},complete:function(){H.Loading.hide()}}))},addIdentity:function(e){var t=this;$.ajax({url:"/identity/add",type:"post",dataType:"json",timeout:1e4,data:{identityName:e},beforeSend:function(){H.Loading.show()},success:function(n){1==n.code?(t.popObj.remove(),H.alert(n.msg,2e3,function(){var i={};t.identityData[n.data.insertId]=i[n.data.insertId]={id:n.data.insertId,identity_competence:"",identity_name:e},$("#J-role-select").append(H.template($("#J-identity-option-tpl").html(),{identityData:i})),$("#J-role-select").val(n.data.insertId),t.createMenu()})):H.alert(n.msg)},error:function(){H.alert("用户信息保存接口调用失败")},complete:function(){H.Loading.hide()}})},delIdentity:function(e){$.ajax({url:"/identity/del",type:"post",type:"json",timeout:1e4,data:{identityId:e},beforeSend:function(){H.Loading.show()},success:function(e){1==e.code?H.alert(e.msg,function(){$("#J-role-select").find("option:selected").remove(),identityManageMod.createMenu()}):H.alert(e.msg)},error:function(){H.alert("用户信息保存接口调用失败")},complete:function(){H.Loading.hide()}})},bindEvents:function(){var e=this;$(document).on("mouseover","#J-menu-wrap .J-menu-item",function(e){e.stopPropagation(),$("#J-menu-wrap .J-menu-item").removeClass("active"),$(this).addClass("active")}).on("mouseleave","#J-menu-wrap .J-menu-item",function(e){$(this).removeClass("active")}).on("change","#J-menu-wrap input[type=checkbox]",function(e){this.checked?$(this).parents(".J-menu-item").not($(this).closest(".J-menu-item")).each(function(){$(this).find(">span").find("input[type=checkbox]").prop("checked",!0)}):$(this).closest(".J-menu-item").find("input[type=checkbox]").prop("checked",!1)}).on("submit","#J-pop-form",function(t){t.preventDefault();var n=$("#J-pop-form").find("input[name=identityName]").val();return""==n?void H.alert("角色名不能为空"):void e.addIdentity(n)}).on("click","#J-pop-cancel-btn",function(){e.popObj.remove()}).on("click","#J-nav-wrap li",function(){$(this).addClass("active").siblings().removeClass("active"),$("#J-content-wrap").children().eq($(this).index()).show().siblings().hide()}),$("#J-role-select").on("change",function(){e.createMenu()}),$("#J-save-btn").on("click",function(){e.saveIdentityCompetence()}),$("#J-add-btn").on("click",function(){e.popObj=H.dialog({title:"新增角色",content:$("#J-pop-tpl").html(),quickClose:!0,padding:10,backdropOpacity:.3,onshow:function(){},onclose:function(){}}).show()}),$("#J-del-btn").on("click",function(){H.confirm({content:"确定要删除此角色？",quickClose:!0,width:300,okValue:"确定",backdropOpacity:.3,ok:function(){e.delIdentity($("#J-role-select").val())},cancelValue:"取消",cancel:function(){}}).show()})}};$(function(){identityManageMod.init()});