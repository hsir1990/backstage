var competenceManageMod={pagePopObj:null,competencePopObj:null,pageData:null,competenceData:null,curPage:"",init:function(){var e=this;e.getPageList(function(){null!=e.pageData&&e.getCompetenceList()}),e.bindEvents()},getPageList:function(e){var t=this;$.ajax({url:"/competence/pageList",type:"get",dataType:"json",timeout:1e4,beforeSend:function(){H.Loading.show()},success:function(n){if(n.code=1){if(n.data.length>0){var a={};$.each(n.data,function(e,t){a[t.id]=t}),t.pageData=a,$("#J-page-select").html(H.template($("#J-page-option-tpl").html(),{pageData:t.pageData}))}else t.pageData=null,$("#J-page-select").html('<option value="">请先创建权限管理模块</option>');t.curPage&&$("#J-page-select").val(t.curPage),e&&e()}else H.alert("模块数据获取失败")},error:function(){H.alert("模块数据获取失败")},complete:function(){H.Loading.hide()}})},getCompetenceList:function(){var e=this;return""==$("#J-page-select").val()?void H.alert("请先创建模块"):void $.ajax({type:"get",dataType:"json",url:"/competence/competenceList",data:{pageId:$("#J-page-select").val()},beforeSend:function(){H.Loading.show()},success:function(t){1==t.code?(e.competenceData=t.data,e.renderCompetenceList()):H.alert("权限数据获取失败")},error:function(){H.alert("权限数据获取失败")},complete:function(){H.Loading.hide()}})},renderCompetenceList:function(){var e=this,t=H.template($("#J-competence-tpl").html(),{pageName:e.pageData[$("#J-page-select").val()].name,items:e.competenceData});$("#J-competence-wrap").html(t)},savePage:function(e){var t=this;$.ajax({url:"/competence/savePage",type:"post",dataType:"json",timeout:1e4,data:e,beforeSend:function(){H.Loading.show()},success:function(e){1==e.code?(t.pagePopObj&&t.pagePopObj.remove(),H.alert("操作成功！",function(){t.getPageList()})):H.alert(e.msg)},error:function(){H.alert("操作失败")},complete:function(){H.Loading.hide()}})},delPage:function(e){var t=this;$.ajax({url:"/competence/deletePage",type:"post",dataType:"json",timeout:1e4,data:{id:e},beforeSend:function(){H.Loading.show()},success:function(e){1==e.code?H.alert("删除模块成功",function(){t.curPage="",t.getPageList(function(){null!=t.pageData&&t.getCompetenceList()})}):H.alert(e.msg)},error:function(){H.alert("删除模块失败")},complete:function(){H.Loading.hide()}})},saveCompetence:function(e){var t=this;$.ajax({url:"/competence/saveCompetence",type:"post",dataType:"json",timeout:1e4,data:e,beforeSend:function(){H.Loading.show()},success:function(e){1==e.code?(t.competencePopObj.remove(),H.alert("操作成功",function(){t.getCompetenceList()})):H.alert(e.msg)},error:function(){H.alert("操作失败")},complete:function(){H.Loading.hide()}})},delCompetence:function(e){var t=this;$.ajax({url:"/competence/deleteCompetence",type:"post",dataType:"json",timeout:1e4,data:{id:e},beforeSend:function(){H.Loading.show()},success:function(e){1==e.code?H.alert("删除权限成功",function(){t.getCompetenceList()}):H.alert(e.msg)},error:function(){H.alert("删除权限失败")},complete:function(){H.Loading.hide()}})},showCompetencePop:function(e,t){var n=this;n.competencePopObj=H.dialog({title:e?"新增权限":"修改权限",content:$("#J-competence-pop-tpl").html(),quickClose:!0,padding:10,backdropOpacity:.3,onshow:function(){var a=$("#J-competence-form");if(a.find("select[name=page_id]").html(H.template($("#J-page-option-tpl").html(),{pageData:n.pageData})),e){var o=n.competenceData[t];a.find("input[name=id]").val(o.id),a.find("input[name=name]").val(o.name),a.find("select[name=page_id]").val(o.page_id),a.find("textarea[name=description]").val(o.description),a.find("input[name=selector]").val(o.selector)}},onclose:function(){}}).show()},bindEvents:function(){var e=this;$(document).on("submit","#J-page-form",function(t){t.preventDefault();var n=$("#J-page-form").find("input[name=name]").val();return""==n?void H.alert("模块名不能为空"):void e.savePage({name:n})}).on("click","#J-page-cancel-btn",function(){e.pagePopObj.remove()}).on("submit","#J-competence-form",function(t){t.preventDefault();var n=$("#J-competence-form"),a=n.find("input[name=id]").val(),o=n.find("input[name=name]").val(),c=n.find("select[name=page_id]").val(),i=n.find("textarea[name=description]").val(),p=n.find("input[name=selector]").val();return""==o?void H.alert("权限名不能为空"):""==p?void H.alert("选择器不能为空"):void e.saveCompetence({id:a,name:o,pageId:c,description:i,selector:p})}).on("click","#J-competence-cancel-btn",function(){e.competencePopObj.remove()}).on("click","#J-competence-wrap .J-edit-btn",function(t){t.preventDefault(),e.showCompetencePop(!0,$(this).data("index"))}).on("click","#J-competence-wrap .J-del-btn",function(t){t.preventDefault();var n=$(this).data("id");H.confirm({content:"确定要删除此权限？",quickClose:!0,width:300,okValue:"确定",backdropOpacity:.3,ok:function(){e.delCompetence(n)},cancelValue:"取消",cancel:function(){}}).show()}).on("click","#J-save-btn",function(){var t=$("#J-page-name").val();return""==t?void H.alert("模块名不能为空"):void e.savePage({id:$("#J-page-select").val(),name:t})}),$("#J-page-select").on("change",function(){e.curPage=$(this).val(),e.getCompetenceList()}),$("#J-add-btn").on("click",function(){e.pagePopObj=H.dialog({title:"新增权限管理模块",content:$("#J-page-pop-tpl").html(),quickClose:!0,padding:10,backdropOpacity:.3,onshow:function(){},onclose:function(){}}).show()}),$("#J-del-btn").on("click",function(){return""==$("#J-page-select").val()?void H.alert("没有模块可删除，请先创建模块"):void H.confirm({content:"确定要删除此模块？",quickClose:!0,width:300,okValue:"确定",backdropOpacity:.3,ok:function(){e.delPage($("#J-page-select").val())},cancelValue:"取消",cancel:function(){}}).show()}),$("#J-create-btn").on("click",function(){return""==$("#J-page-select").val()?void H.alert("请先创建模块"):void e.showCompetencePop()})}};$(function(){competenceManageMod.init()});